import Groq from 'groq-sdk';

const groq = new Groq({
    apiKey: import.meta.env.VITE_GROQ_API_KEY,
    dangerouslyAllowBrowser: true
});

// Dicion√°rio de sin√¥nimos EXPANDIDO (60+ termos)
const SYNONYM_DICT = {
    // Sa√∫de (expandido)
    'dentista': ['odontologia', 'odontol√≥gica', 'consult√≥rio dent√°rio', 'dente', 'dental', 'ortodontia'],
    'm√©dico': ['consult√≥rio m√©dico', 'cl√≠nica m√©dica', 'medicina', 'consulta', 'sa√∫de', 'ambulat√≥rio'],
    'fisio': ['fisioterapia', 'fisioterapeuta', 'reabilita√ß√£o'],
    'psic√≥logo': ['psicologia', 'psican√°lise', 'terapia', 'psicoterapia'],
    'nutricionista': ['nutri√ß√£o', 'nutricional', 'alimenta√ß√£o'],
    'enfermeiro': ['enfermagem', 'cuidados', 'sa√∫de'],
    'farm√°cia': ['drogaria', 'medicamento', 'rem√©dio'],
    'lab': ['laborat√≥rio', 'exame', 'an√°lise', 'cl√≠nico'],
    'cl√≠nica': ['consult√≥rio', 'ambulat√≥rio', 'sa√∫de'],

    // Alimenta√ß√£o (expandido)
    'padaria': ['panificadora', 'p√£o', 'confeitaria', 'padeiro', 'panifica√ß√£o'],
    'lanchonete': ['lanche', 'fast food', 'snack bar', 'lanches'],
    'restaurante': ['comida', 'refei√ß√£o', 'gastronomia', 'alimenta√ß√£o', 'restaura√ß√£o'],
    'bar': ['boteco', 'cervejaria', 'pub', 'bebida', 'bebidas'],
    'buffet': ['evento', 'festa', 'recep√ß√£o', 'eventos'],
    'caf√©': ['cafeteria', 'coffee', 'lanchonete'],
    'a√ßougue': ['carne', 'a√ßougueiro', 'frigor√≠fico'],
    'mercado': ['supermercado', 'mercearia', 'minimercado', 'varejo'],

    // Tecnologia (expandido)
    'dev': ['desenvolvedor', 'programador', 'software', 'ti', 'programa√ß√£o', 'desenvolvimento'],
    'site': ['website', 'web', 'internet', 'p√°gina', 'portal'],
    'app': ['aplicativo', 'mobile', 'celular', 'aplica√ß√£o'],
    'ti': ['tecnologia da informa√ß√£o', 'inform√°tica', 'computa√ß√£o', 'tech'],
    'software': ['programa', 'sistema', 'aplicativo'],
    'consultoria': ['consultor', 'assessoria', 'servi√ßos'],

    // Com√©rcio (expandido)
    'loja': ['com√©rcio', 'varejo', 'vendas', 'comercial'],
    'supermercado': ['mercado', 'mercearia', 'varejo'],
    'farm√°cia': ['drogaria'],
    'boutique': ['vestu√°rio', 'roupa', 'moda', 'roupas'],
    'livraria': ['livro', 'livros', 'papelaria'],
    'pet': ['animal', 'animais', 'veterin√°rio', 'ra√ß√£o'],

    // Servi√ßos (expandido)
    'advogado': ['advocacia', 'jur√≠dico', 'direito', 'lei'],
    'contador': ['contabilidade', 'cont√°bil', 'contabilista'],
    'engenheiro': ['engenharia', 'projeto', 'constru√ß√£o'],
    'arquiteto': ['arquitetura', 'projeto', 'design'],
    'imobili√°ria': ['im√≥vel', 'im√≥veis', 'corretagem', 'corretor'],

    // Educa√ß√£o (expandido)
    'escola': ['ensino', 'educa√ß√£o', 'col√©gio', 'educacional'],
    'curso': ['treinamento', 'forma√ß√£o', 'aula', 'cursos'],
    'idioma': ['l√≠ngua', 'ingl√™s', 'espanhol', 'idiomas'],
    'academia': ['gin√°stica', 'fitness', 'muscula√ß√£o'],

    // Ind√∫stria
    'f√°brica': ['fabrica√ß√£o', 'ind√∫stria', 'manufatura', 'produ√ß√£o'],
    'oficina': ['mec√¢nica', 'conserto', 'reparo', 'manuten√ß√£o'],

    // Outros
    'sal√£o': ['beleza', 'cabelo', 'est√©tica', 'cabeleireiro'],
    'hotel': ['hotelaria', 'hospedagem', 'pousada'],
    'transporte': ['frete', 'log√≠stica', 'transportadora']
};

/**
 * Expande termos de busca com sin√¥nimos
 */
function expandWithSynonyms(searchTerm) {
    const term = searchTerm.toLowerCase().trim();
    const expanded = [term];

    // Adiciona sin√¥nimos se encontrar
    for (const [key, synonyms] of Object.entries(SYNONYM_DICT)) {
        if (term.includes(key) || key.includes(term)) {
            expanded.push(...synonyms);
        }
    }

    return [...new Set(expanded)]; // Remove duplicatas
}

export async function findCNAEsByAI(description, cnaeList) {
    if (!description || description.length < 2) {
        return [];
    }

    try {
        console.log(`ü§ñ IA processando: "${description}"`);
        console.log(`üìä Base de dados: ${cnaeList.length} CNAEs dispon√≠veis`);

        // NOVO: SEM PR√â-FILTRO LOCAL - IA recebe TODA a base IBGE
        // Prepara lista completa de CNAEs para IA
        const cnaeListText = cnaeList
            .slice(0, 100) // Limita a 100 para n√£o estourar token limit
            .map(cnae => `${cnae.value || cnae.code} - ${cnae.label || cnae.description}`)
            .join('\n');

        // Prompt EXTREMAMENTE espec√≠fico para evitar erros
        const prompt = `Voc√™ √© um especialista CERTIFICADO em CNAEs do IBGE brasileiro.

TAREFA: Encontrar os CNAEs CORRETOS para: "${description}"

LISTA DE CNAEs DISPON√çVEIS (base IBGE oficial):
${cnaeListText}

‚ö†Ô∏è REGRAS CR√çTICAS - LEIA COM ATEN√á√ÉO:

1. **VALIDA√á√ÉO SEM√ÇNTICA OBRIGAT√ìRIA**
   - Se a descri√ß√£o √© "dentista", voc√™ DEVE retornar APENAS CNAEs de ODONTOLOGIA/SA√öDE
   - Se a descri√ß√£o √© "padaria", voc√™ DEVE retornar APENAS CNAEs de PANIFICA√á√ÉO/ALIMENTOS
   - NUNCA confunda √°reas diferentes (sa√∫de ‚â† tecnologia, com√©rcio ‚â† servi√ßos)

2. **EXEMPLOS DE VALIDA√á√ÉO:**
   ‚úÖ CORRETO: "dentista" ‚Üí 8630-5/03 ou 8630-5/04 (Odontologia)
   ‚ùå ERRADO: "dentista" ‚Üí 6201-5/01 (Desenvolvimento de software) - ISSO NUNCA PODE ACONTECER!
   
   ‚úÖ CORRETO: "padaria" ‚Üí 4721-1/02 ou 1091-1/01 (Panifica√ß√£o)
   ‚ùå ERRADO: "padaria" ‚Üí 8630-5/XX (Sa√∫de) - ISSO NUNCA PODE ACONTECER!

3. **PRIORIZE ESPECIFICIDADE**
   - Escolha CNAEs espec√≠ficos sobre gen√©ricos
   - Evite CNAEs com "n√£o especificadas anteriormente"
   - Evite CNAEs com "outras atividades"

4. **CONTEXTO BRASILEIRO**
   - Para profissionais liberais (m√©dico, dentista, advogado) use c√≥digos da se√ß√£o "Atividades de..."
   - Para com√©rcio, diferencie fabrica√ß√£o (Ind√∫stria) vs revenda (Com√©rcio)

5. **VERIFICA√á√ÉO FINAL**
   Antes de retornar CADA CNAE, fa√ßa estas perguntas:
   - "Este CNAE realmente descreve '${description}'?"
   - "A categoria deste CNAE (sa√∫de/com√©rcio/tecnologia) faz sentido para '${description}'?"
   - "Estou 100% certo desta classifica√ß√£o?"
   
   Se a resposta for N√ÉO para qualquer pergunta, N√ÉO retorne aquele CNAE!

FORMATO DE RESPOSTA (JSON puro, sem markdown):
[
  {
    "code": "1234567",
    "description": "Descri√ß√£o completa copiada do CNAE",
    "confidence": 0.95,
    "reason": "Explique ESPECIFICAMENTE por que este CNAE √© adequado para '${description}'"
  }
]

Retorne EXATAMENTE 5 CNAEs ordenados por relev√¢ncia (confidence 0.0-1.0).

‚ö†Ô∏è IMPORTANTE: Seja EXTREMAMENTE criterioso. √â melhor confidence 0.50 do que sugerir CNAE completamente errado!
‚ö†Ô∏è CR√çTICO: NUNCA misture categorias (ex: sa√∫de com tecnologia)!`;

        // Chamada √† IA Groq com Mixtral
        const chatCompletion = await groq.chat.completions.create({
            messages: [
                {
                    role: 'system',
                    content: `Voc√™ √© um especialista em CNAEs do IBGE com 20+ anos de experi√™ncia em classifica√ß√£o fiscal brasileira.

INSTRU√á√ïES CR√çTICAS:
- SEMPRE valide a CATEGORIA do CNAE (sa√∫de/com√©rcio/tecnologia/etc) contra a descri√ß√£o do usu√°rio
- NUNCA sugira CNAEs de uma categoria diferente (ex: tecnologia para profiss√£o de sa√∫de)
- Priorize CNAEs ESPEC√çFICOS sobre gen√©ricos
- Seja CONSERVADOR: melhor confidence baixo que erro grave de categoria
- Se n√£o tiver certeza ABSOLUTA, reduza drasticamente o confidence

EXEMPLO DE ERRO GRAVE QUE NUNCA PODE ACONTECER:
Usu√°rio: "dentista" ‚Üí Voc√™ sugere: "6201-5/01 - Desenvolvimento de software" ‚ùå INACEIT√ÅVEL!

Voc√™ √© respons√°vel por classifica√ß√µes precisas que afetam neg√≥cios reais e obriga√ß√µes fiscais.`
                },
                {
                    role: 'user',
                    content: prompt
                }
            ],
            model: 'mixtral-8x7b-32768',
            temperature: 0.05, // EXTREMAMENTE baixo para evitar criatividade
            max_tokens: 1500,
            top_p: 0.8,
            presence_penalty: 0.2,
            frequency_penalty: 0.2
        });

        const responseText = chatCompletion.choices[0]?.message?.content || '[]';

        // Extrair JSON
        let jsonText = responseText;
        const jsonMatch = responseText.match(/\[[\s\S]*\]/);
        if (jsonMatch) {
            jsonText = jsonMatch[0];
        }

        const aiResults = JSON.parse(jsonText);

        console.log(`‚úÖ IA retornou ${aiResults.length} CNAEs`);
        console.log('üìã Resultados:', aiResults.map(r => r.code).join(', '));

        // REMOVIDO: Variabilidade (causava inconsist√™ncia)
        // REMOVIDO: Enriquecimento sem√¢ntico (causava pr√©-filtro incorreto)
        // Retorna direto os resultados da IA
        return aiResults;

    } catch (error) {
        console.error('‚ùå Erro ao buscar CNAEs com IA:', error);

        // Fallback: busca simples no c√≥digo
        const simpleFallback = cnaeList
            .filter(cnae => {
                const desc = (cnae.description || cnae.label || '').toLowerCase();
                const query = description.toLowerCase();
                return desc.includes(query);
            })
            .slice(0, 5)
            .map(cnae => ({
                code: cnae.value || cnae.code,
                description: cnae.label || cnae.description,
                confidence: 0.5,
                reason: 'Fallback: match por palavra-chave'
            }));

        return simpleFallback.length > 0 ? simpleFallback : [];
    }
}

/**
 * Busca fuzzy local MELHORADA com sin√¥nimos
 * AGORA MUITO MAIS FLEX√çVEL para encontrar mais resultados
 */
function fuzzySearchCNAEs(description, cnaeList, maxResults = 5) {
    const searchTermsOriginal = description
        .toLowerCase()
        .trim()
        .split(/\s+/)
        .filter(term => term.length > 1); // MUDOU: aceita palavras com 2+ letras

    if (searchTermsOriginal.length === 0) {
        return fallbackSearch(description, cnaeList);
    }

    // Expande com sin√¥nimos
    const allSearchTerms = [];
    searchTermsOriginal.forEach(term => {
        allSearchTerms.push(...expandWithSynonyms(term));
    });

    const uniqueTerms = [...new Set(allSearchTerms)];

    // Calcula score para cada CNAE (MAIS FLEX√çVEL)
    const scored = cnaeList.map(cnae => {
        const label = cnae.label.toLowerCase();
        const code = cnae.value.toLowerCase();
        let score = 0;

        uniqueTerms.forEach(term => {
            // Match exato no texto = score muito alto
            if (label.includes(term)) {
                score += 15; // AUMENTOU de 10 para 15

                // Bonus se est√° no in√≠cio
                if (label.startsWith(term)) {
                    score += 8; // AUMENTOU de 5 para 8
                }

                // Bonus se √© palavra completa
                const regex = new RegExp(`\\b${term}\\b`);
                if (regex.test(label)) {
                    score += 5; // AUMENTOU de 3 para 5
                }
            }

            // Match parcial MAIS FLEX√çVEL
            if (term.length >= 3) {
                const prefix = term.substring(0, 3);
                if (label.includes(prefix)) {
                    score += 4; // AUMENTOU de 2 para 4
                }
            }

            // NOVO: Match de 2 letras se termo for curto
            if (term.length === 2 || term.length === 3) {
                if (label.includes(term)) {
                    score += 6;
                }
            }

            // NOVO: Match de palavras similares (Levenshtein simplificado)
            const words = label.split(/[\s\-\/]/);
            words.forEach(word => {
                if (word.length > 3 && term.length > 3) {
                    // Se come√ßam igual (primeiras 3 letras)
                    if (word.substring(0, 3) === term.substring(0, 3)) {
                        score += 3;
                    }
                }
            });
        });

        return {
            code: cnae.value,
            description: cnae.label,
            relevance: Math.min(score * 5, 100), // MUDOU: score * 5 (antes era * 8)
            rawScore: score
        };
    });

    // MUDOU: Aceita scores menores (1+ em vez de s√≥ > 0)
    // Mostra MUITO mais resultados agora
    return scored
        .filter(item => item.rawScore >= 1) // Threshold MUITO baixo
        .sort((a, b) => b.rawScore - a.rawScore)
        .slice(0, maxResults)
        .map(({ code, description, relevance }) => ({
            code,
            description,
            relevance,
            source: 'local'
        }));
}

/**
 * Busca fallback simples
 */
function fallbackSearch(description, cnaeList) {
    const searchTerm = description.toLowerCase().trim();

    return cnaeList
        .filter(cnae =>
            cnae.label.toLowerCase().includes(searchTerm)
        )
        .slice(0, 5)
        .map(cnae => ({
            code: cnae.value,
            description: cnae.label,
            relevance: 60,
            source: 'fallback'
        }));
}

/**
 * Verifica se a IA est√° configurada (Groq)
 */
export function isAIConfigured() {
    return !!import.meta.env.VITE_GROQ_API_KEY;
}
